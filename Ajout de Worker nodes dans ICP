* Ajout de Worker nodes dans ICP
   - La première étape consiste à prendre une VM disponibles dans le fichier d'inventaire.
       S'il n'y a pas de VMs dipsonible il faudra en créer une sur le portail cloud.

   - Copie de la clé SSH du boot node sur le nouveau worker

          ssh-copy-id -i ~/.ssh/id_rsa.pub s01vl9903896
          utiliser le mot de passe root de passwordvault


  - Arrêt de la VM et ajout du paramètre disk.EnableUUID à TRUE sur le Vcenter


     -Passage des pré-requis en utilisant le playbook ansible


bootnode> git clone https://gitlab-dogen.group.echonet/Production-mutualisee/bp2i/cloud-ng/cloud-ng-icp/ansible-icp.git
bootnode> git checkout 3.2.0
bootnode> cd ansible-icp
bootnode> git checkout 3.2.0
Mettre à jour l'inventaire pour n'inclure que le nouveau worker noeud (ça ne sert à rien à définir les autres noeuds dans l'inventaire)
bootnode> vim inventory.sample.ini
[worker]
s01vl9903896

bootnode> ansible-playbook icp-main.yml -i inventory.sample.ini

* installation de docker

bootnode> scp /opt/icp/icp-docker-18.06.2_x86_64.bin s01vl9903896:/tmp

workernode> chmod u+x /tmp/icp-docker-18.06.2_x86_64.bin
workernode> /tmp/icp-docker-18.06.2_x86_64.bin --install
[19-10-30 15:20:20] ACTION: install
[19-10-30 15:20:20] DOCKER_ENV:
[19-10-30 15:20:20] DOCKER_CONFIG:
[19-10-30 15:20:20] Installing docker
[19-10-30 15:20:20] Extracting docker.tar.gz
[19-10-30 15:20:21] Installing docker dependent package
[19-10-30 15:20:44] Configuring docker service
[19-10-30 15:20:44] Restarting docker service
[19-10-30 15:20:45] Install docker successfully.

workernode> cat > /etc/systemd/system/docker.service.d/overlay2.conf
[Service]
ExecStart=
ExecStart=/usr/bin/dockerd --log-opt max-size=10m --log-opt max-file=10 --storage-driver=overlay2 --storage-opt overlay2.override_kernel_check=true --exec-opt native.cgroupdriver=systemd


workernode> systemctl daemon-reload
workernode> systemctl restart docker
workernode> systemctl enable docker

 * montage des partages NFS

 * mount share nfs
    ajout des Ips à partir du portail cloud

workernode> mkdir /fileas2
workernode> mkdir /fileas1

workernode> vim /etc/fstab
[...]
s00vf9993942.fr.net.intra:/vol_SVM_DMZ_MULTI_PROD_008/a00nn9371822_qtree /fileas1 nfs4    defaults 0 0
s00vf9993942.fr.net.intra:/vol_SVM_DMZ_MULTI_PROD_008/a00nn9371829_qtree /fileas2 nfs4    defaults 0 0

mount -a

* Ajout des règles de monitoring

/apps/nimsoft/custo/scripts/exploitation/PolicyGroupManage.ksh -a add -g AB_AP24034_ICP_DBAAS
/apps/nimsoft/custo/scripts/exploitation/PolicyGroupManage.ksh -a add -g AB_AP24034_ICP_WORKER
/apps/nimsoft/custo/scripts/exploitation/PolicyGroupManage.ksh -a add -g M_AP10570_IPSTOOLBOXES
/apps/nimsoft/custo/scripts/exploitation/PolicyGroupManage.ksh -a add -g M_BIGFIX-AGENT-UNIX
/apps/nimsoft/custo/scripts/exploitation/PolicyGroupManage.ksh -a add -g M_ETAC
/apps/nimsoft/custo/scripts/exploitation/PolicyGroupManage.ksh -a add -g M_IPSEXPLOIT
/apps/nimsoft/custo/scripts/exploitation/PolicyGroupManage.ksh -a add -g M_ITCM-AGENT-UNIX
/apps/nimsoft/custo/scripts/exploitation/PolicyGroupManage.ksh -a add -g M_LINUX-V6
/apps/nimsoft/custo/scripts/exploitation/PolicyGroupManage.ksh -a add -g M_NIMSOFT-AGENT-UNIX
/apps/nimsoft/custo/scripts/exploitation/PolicyGroupManage.ksh -a add -g M_NIMSOFT-GET-INFO
/apps/nimsoft/custo/scripts/exploitation/PolicyGroupManage.ksh -a add -g M_SCM-LINUX
/apps/nimsoft/custo/scripts/exploitation/PolicyGroupManage.ksh -a add -g M_VMWARE-TOOLS-SD
/apps/nimsoft/custo/scripts/exploitation/PolicyGroupManage.ksh -a add -g O_LINUX


* Créer une Delphes de mise en pilotage

Il faut créer une Delphes avec la CRO 19586 afin de mettre en pilotage la nouvelle VM

Pull de l'image calico-cni

Pour des raisons obscures, lors de l'ajout d'un worker celui-ci n'arrive pas à Pull l'image calico.
Afin de ne pas avoir de problème avec la couche réseaux du worker il est préférable de pull l'image en question manuellement.
docker login cloudngc02.group.echonet:8500
docker pull cloudngc02.group.echonet:8500/ibmcom/calico-cni:v3.5.2
docker pull cloudngc02.group.echonet:8500/ibmcom/calico-node:v3.5.2

Ajout du worker dans le cluster

bootnode> cd /opt/icp/ibm-cloud-private-3.2.0/cluster/

bootnode> docker run -e LICENSE=accept --net=host -v "$(pwd)":/installer/cluster ibmcom/icp-inception-amd64:3.2.0.1907-ee worker -l 10.241.204.67
